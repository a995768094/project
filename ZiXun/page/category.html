<div>
    <div class="btns">
        <button type="button" id='add_btn' class="btn btn-primary">新增</button>
        <button type="button" id='batch_btn' class="btn btn-danger">批量删除</button>
    </div>

    <table class="table">
        <thead>
          <tr>
            <th scope="col">编号</th>
            <th scope="col">栏目名称</th>
            <th scope="col">栏目描述</th>
            <th scope="col">父栏目</th>
            <th scope="col">操作</th>
          </tr>
        </thead>
        <tbody>
          
        </tbody>
    </table>

    <!-- 模态框 -->
    <div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="categoryModalLabel">新增栏目</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                      <label for="category_name">栏目名称</label>
                      <input type="email" class="form-control" id="category_name" aria-describedby="emailHelp">
                    </div>

                    <div class="form-group">
                        <label for="catgory_parentId">父栏目</label>
                        <select class="form-control" id="catgory_parentId">
                          <option value=""></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category_desription">栏目描述</label>
                        <textarea id='category_desription' class="form-control" aria-label="With textarea"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id='true_btn'>确定</button>
            </div>
        </div>
        </div>
    </div>
</div>
<style>

</style>
<script>
    var allData;
    var id;
    // 获取token并设置到请求头中
    var token = localStorage.getItem('token')
    $.ajaxSetup({
        headers:{
            'Authorization':token
        }
    })

    // 6. 修改
    $('tbody').on('click','.edit_btn',function(){
        // 6.1 获取当前点击行的id
        id = $(this).closest('tr').find('input').val()
        // 6.2 显示模态框
        $('#categoryModal').modal('show')

        var editData = allData.filter(function(item){
            return item.id == id
        })
        $('#category_name').val(editData[0].name)
        $('#catgory_parentId').val(editData[0].parentId)
        $('#category_desription').val(editData[0].description)
    })

    // 5. 批量删除
    $('#batch_btn').click(function() {
        // 5.1 获取所有被选中的多选框的id值
        var inputs = $(':checkbox:checked')
        // 5.2 将id值放入一个数组并转换成字符串
        var arr = [];
        Array.from(inputs).forEach(function(item){
            arr.push(item.value)
        })
        // 5.3 发送请求
        $.post('http://47.93.255.92:7788/category/batchDelete',{
            ids:arr.toString()
        },function(res){
            if(res.status == 500){
                alert(res.message)
            } else {
                // 5.4 刷新数据
                findAllCategory()
            }
        })

        // var res = Array.from(inputs).map(function(item){
        //     return item.value
        // })
        // console.log(res)
    })

    // 4. 删除 - 事件代理
    $('tbody').on('click','.delete_btn',function(){
        // 4.1 获取当前点击行的id
        var id = $(this).closest('tr').find('input').val()
        // 4.2 发送请求
        $.get('http://47.93.255.92:7788/category/deleteById',{id:id},function(res){
            if(res.status == 500){
                alert(res.message)
            } else {
                // 4.3 刷新数据
                findAllCategory()
            }
        })
    })

    // 3. 新增/修改栏目
    $('#true_btn').click(function() {
        // 3.1 获取输入框的值
        var name = $('#category_name').val()
        var parentId = $('#catgory_parentId').val()
        var description = $('#category_desription').val()

        // 如果id存在，表示该操作为修改
        if(id){
            var data = {
                id:id,
                name:name,
                parentId:parentId,
                description:description
            }
        } else {
            // 如果id不存在，表示该操作为新增
            var data = {
                name:name,
                parentId:parentId,
                description:description
            }
        }
        
        // 3.2 发送请求
        $.post('http://47.93.255.92:7788/category/saveOrUpdate',data,function(res){
            // 3.3 关闭模态框
            $('#categoryModal').modal('hide')
            // 3.4 刷新数据
            findAllCategory()
        })
    })

    // 2. 显示模态框
    $('#add_btn').click(function() {
        // 显示模态框
        $('#categoryModal').modal('show')
    })

    // 1. 查询所有的栏目
    function findAllCategory(){
        $.get('http://47.93.255.92:7788/category/findAll',function(res){
            $('tbody').empty()
            res.data.forEach(function(item){
                var newTr = $(`
                    <tr>
                        <td><input type="checkbox" value="`+item.id+`"></td>
                        <td>`+item.name+`</td>
                        <td>`+item.description+`</td>
                        <td>`+item.parentId+`</td>
                        <td>
                            <span class='delete_btn'>删除</span>
                            <span class='edit_btn'>修改</span>
                        </td>
                    </tr>
                `)
                $('tbody').append(newTr)
            })

            // 过滤出所有的父栏目
            var parent = res.data.filter(function(item){
                return item.parentId == null
            })

            parent.forEach(function(item){
                var newOption = $(`
                    <option value="`+item.id+`">`+item.name+`</option>
                `)
                $('#catgory_parentId').append(newOption)
            })

            allData = res.data
        })
    }    
    findAllCategory()
</script>